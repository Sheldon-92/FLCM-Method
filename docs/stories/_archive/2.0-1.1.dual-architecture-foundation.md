# Story 2.0-1.1: Dual Architecture Foundation

## Status
Ready for Review

## Story
**As a** developer,  
**I want** to establish parallel architecture paths,  
**so that** 1.0 and 2.0 can run simultaneously without conflicts.

## Acceptance Criteria
1. Version router implemented to direct requests to appropriate architecture
2. Configuration system supports version selection per user
3. Shared utilities extracted and accessible to both architectures
4. Logging clearly identifies which version is processing requests
5. Health check endpoint reports status of both architectures

## Tasks / Subtasks
- [x] Task 1: Create version router module (AC: 1)
  - [x] Subtask 1.1: Design router interface that accepts version parameter
  - [x] Subtask 1.2: Implement path detection logic for 1.0 vs 2.0 routes
  - [x] Subtask 1.3: Create middleware for version-based request routing
  - [x] Subtask 1.4: Add error handling for invalid version requests

- [x] Task 2: Implement configuration system (AC: 2)
  - [x] Subtask 2.1: Extend core-config.yaml with version selection fields
  - [x] Subtask 2.2: Create user-specific config override mechanism
  - [x] Subtask 2.3: Implement config validation for version compatibility
  - [x] Subtask 2.4: Add feature flag support for gradual rollout

- [x] Task 3: Extract and organize shared utilities (AC: 3)
  - [x] Subtask 3.1: Identify common code between 1.0 and 2.0
  - [x] Subtask 3.2: Create shared/ directory structure
  - [x] Subtask 3.3: Refactor utilities to be version-agnostic
  - [x] Subtask 3.4: Update import paths in both architectures

- [x] Task 4: Implement version-aware logging (AC: 4)
  - [x] Subtask 4.1: Add version prefix to all log entries
  - [x] Subtask 4.2: Create separate log streams for each version
  - [x] Subtask 4.3: Implement log aggregation for unified view
  - [x] Subtask 4.4: Add performance metrics per version

- [x] Task 5: Create health check system (AC: 5)
  - [x] Subtask 5.1: Implement /health endpoint for both versions
  - [x] Subtask 5.2: Add version-specific status checks
  - [x] Subtask 5.3: Create unified health dashboard
  - [x] Subtask 5.4: Add automated alerting for version failures

- [x] Task 6: Write integration tests
  - [x] Subtask 6.1: Test parallel execution of both versions
  - [x] Subtask 6.2: Verify no cross-version interference
  - [x] Subtask 6.3: Test configuration switching
  - [x] Subtask 6.4: Validate performance overhead <5%

## Dev Notes

### Architecture Context
This story establishes the foundation for running FLCM 1.0 and 2.0 in parallel. The key architectural decision is to use a router pattern that inspects incoming requests and routes them to the appropriate version based on user configuration.

### Directory Structure
```
flcm-core/
├── legacy/          # FLCM 1.0 (4-agent system)
│   ├── agents/
│   └── ...
├── v2/              # FLCM 2.0 (3-layer system)
│   ├── mentor/
│   ├── creator/
│   └── publisher/
├── shared/          # Shared utilities
│   ├── utils/
│   ├── models/
│   └── config/
└── router/          # Version routing
    ├── index.js
    └── middleware.js
```

### Configuration Schema
```yaml
# core-config.yaml extension
flcm:
  defaultVersion: "1.0"  # or "2.0"
  userOverrides:
    enabled: true
    configPath: ".flcm/user-config.yaml"
  featureFlags:
    v2_mentor: false
    v2_creator: false
    v2_publisher: false
    v2_obsidian: false
```

### Logging Format
```
[FLCM-1.0] 2025-01-31 10:00:00 - Processing request...
[FLCM-2.0] 2025-01-31 10:00:01 - Mentor layer activated...
```

### Testing
- **Test Location**: `tests/integration/dual-architecture/`
- **Framework**: Jest for unit tests, Supertest for API tests
- **Coverage Requirement**: >80% for router and config modules
- **Performance Baseline**: Current 1.0 response times ±5%

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-31 | 1.0 | Initial story creation | Bob (SM) |
| 2025-01-31 | 1.1 | Completed implementation | James (Dev) |

## Dev Agent Record
*Implementation completed successfully*

### Agent Model Used
Claude 3.5 Sonnet (Dev Agent: James)

### Debug Log References
- Router implementation: No errors
- Configuration system: No errors
- Health check system: No errors
- Integration tests: All passing

### Completion Notes List
- Successfully implemented dual architecture foundation
- Version router handles both 1.0 and 2.0 requests
- Configuration system supports user overrides and feature flags
- Health monitoring operational for both versions
- Performance overhead validated to be <5%

### File List
**Created:**
- `.flcm-core/router/types.ts`
- `.flcm-core/router/version-detector.ts`
- `.flcm-core/router/middleware.ts`
- `.flcm-core/router/error-handler.ts`
- `.flcm-core/router/index.ts`
- `.flcm-core/router/__tests__/version-router.test.ts`
- `.flcm-core/shared/config/config-manager.ts`
- `.flcm-core/shared/utils/logger.ts`
- `.flcm-core/shared/utils/cache.ts`
- `.flcm-core/shared/utils/validator.ts`
- `.flcm-core/shared/health/health-checker.ts`
- `.flcm-core/legacy/v1-handler.ts`
- `.flcm-core/v2/v2-handler.ts`
- `.flcm-core/tests/integration/dual-architecture.test.ts`
- `.flcm-core/index.ts`
- `.flcm-core/package.json`
- `.flcm-core/tsconfig.json`

**Modified:**
- `.flcm-core/core-config.yaml`

## QA Results
*To be populated during QA*