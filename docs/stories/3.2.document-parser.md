# Story 3.2: Document Parser Implementation

## Status
Approved

## Story
**As a** user,  
**I want** to process various document formats,  
**so that** I can work with diverse content sources.

**Estimated Time:** 3-4 hours

## Acceptance Criteria
1. Markdown file parsing implemented
2. PDF extraction supported (if feasible)
3. Plain text processing added
4. Document structure preservation
5. Image caption extraction attempted
6. Source attribution maintained

## Tasks / Subtasks
- [ ] Implement Markdown parser (AC: 1, 4)
  - [ ] Parse frontmatter (YAML)
  - [ ] Extract headers and structure
  - [ ] Preserve code blocks
  - [ ] Handle links and references
  - [ ] Extract images with alt text
  - [ ] Maintain formatting integrity
- [ ] Add PDF extraction support (AC: 2)
  - [ ] Check if PDF libraries available in Claude Code
  - [ ] If not available, provide fallback message
  - [ ] Extract text content if possible
  - [ ] Preserve page structure
  - [ ] Extract metadata (title, author)
  - [ ] Note: Mark as optional feature
- [ ] Implement plain text processor (AC: 3)
  - [ ] Handle various encodings (UTF-8, etc.)
  - [ ] Detect paragraph boundaries
  - [ ] Identify potential headers
  - [ ] Preserve whitespace where meaningful
  - [ ] Handle special characters
- [ ] Preserve document structure (AC: 4)
  - [ ] Maintain heading hierarchy
  - [ ] Keep list structures
  - [ ] Preserve blockquotes
  - [ ] Maintain table formatting
  - [ ] Keep code block languages
  - [ ] Preserve link relationships
- [ ] Extract image information (AC: 5)
  - [ ] Find image references in markdown
  - [ ] Extract alt text as captions
  - [ ] Note image URLs/paths
  - [ ] Create placeholder for images
  - [ ] Log image metadata
- [ ] Maintain source attribution (AC: 6)
  - [ ] Track original file path/URL
  - [ ] Preserve author information
  - [ ] Keep creation/modification dates
  - [ ] Add source type identifier
  - [ ] Include processing timestamp
  - [ ] Generate source citation

## Dev Notes

### Document Parser Architecture:
```typescript
interface DocumentParser {
  parse(content: string, type: DocumentType): ParsedDocument;
  detectType(content: string): DocumentType;
  extractStructure(doc: ParsedDocument): DocumentStructure;
}

interface ParsedDocument {
  type: 'markdown' | 'text' | 'pdf';
  content: string;
  structure: DocumentStructure;
  metadata: DocumentMetadata;
  images: ImageReference[];
  source: SourceAttribution;
}

interface DocumentStructure {
  headings: Heading[];
  paragraphs: string[];
  lists: ListItem[];
  codeBlocks: CodeBlock[];
  tables: Table[];
  blockquotes: string[];
}

interface SourceAttribution {
  originalPath: string;
  type: DocumentType;
  author?: string;
  createdAt?: Date;
  modifiedAt?: Date;
  processedAt: Date;
}
```

### Markdown Parsing:
Use gray-matter for frontmatter extraction:
```typescript
import matter from 'gray-matter';

const { data, content } = matter(markdownString);
// data contains frontmatter
// content contains markdown body
```

### Document Type Detection:
```typescript
function detectDocumentType(content: string): DocumentType {
  // Check for markdown indicators
  if (content.includes('```') || content.match(/^#+ /m)) {
    return 'markdown';
  }
  // Check for PDF magic bytes (if buffer)
  if (content.startsWith('%PDF')) {
    return 'pdf';
  }
  // Default to plain text
  return 'text';
}
```

### Structure Extraction Patterns:
- **Headers**: `/^#{1,6}\s+(.+)$/gm`
- **Code blocks**: `/```[\s\S]*?```/g`
- **Lists**: `/^[\*\-\+]\s+(.+)$/gm`
- **Images**: `/!\[([^\]]*)\]\(([^)]+)\)/g`

### PDF Support Note:
PDF parsing may not be available in Claude Code environment. Implement graceful fallback:
```typescript
try {
  // Attempt PDF parsing if library available
  const pdfContent = await parsePDF(buffer);
  return pdfContent;
} catch (error) {
  return {
    error: 'PDF_NOT_SUPPORTED',
    message: 'PDF parsing not available. Please convert to text or markdown.',
    fallback: 'Upload PDF content as text'
  };
}
```

### Testing
**Testing Framework:** Jest
**Test File Location:** `.flcm-core/tests/collector/`

**Unit Tests:**
- Parse various markdown samples
- Test frontmatter extraction
- Verify structure preservation
- Test plain text processing
- Validate source attribution

**Test Documents:**
```
tests/fixtures/
├── sample.md (with frontmatter)
├── complex.md (nested structures)
├── plain.txt
└── code-heavy.md
```

**Integration Tests:**
- Parse real document files
- Test structure extraction accuracy
- Verify metadata preservation
- Check error handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_