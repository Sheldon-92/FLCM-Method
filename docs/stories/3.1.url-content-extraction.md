# Story 3.1: URL Content Extraction

## Status
Approved

## Story
**As a** user,  
**I want** to input URLs for processing,  
**so that** I can extract insights from web content.

**Estimated Time:** 4-5 hours

## Acceptance Criteria
1. URL validation and sanitization implemented
2. Web content fetching with error handling
3. HTML to markdown conversion working
4. Metadata extraction (title, author, date)
5. Rate limiting and retry logic added
6. Multiple URL batch processing supported

## Tasks / Subtasks
- [ ] Implement URL validation and sanitization (AC: 1)
  - [ ] Create URLValidator class
  - [ ] Validate URL format (http/https)
  - [ ] Sanitize query parameters
  - [ ] Check for malicious patterns
  - [ ] Handle URL shorteners (expand if needed)
  - [ ] Support relative URL resolution
- [ ] Build web content fetcher (AC: 2)
  - [ ] Implement fetch wrapper with timeout
  - [ ] Add error handling for network failures
  - [ ] Handle different HTTP status codes
  - [ ] Support redirect following (3xx)
  - [ ] Implement request headers (User-Agent, etc.)
  - [ ] Add response size limits
- [ ] Create HTML to Markdown converter (AC: 3)
  - [ ] Use turndown library or similar
  - [ ] Preserve important formatting
  - [ ] Handle nested structures
  - [ ] Clean up unnecessary HTML tags
  - [ ] Preserve links and references
  - [ ] Handle code blocks and preformatted text
- [ ] Extract metadata from content (AC: 4)
  - [ ] Parse HTML meta tags
  - [ ] Extract Open Graph data
  - [ ] Find author information
  - [ ] Extract publication date
  - [ ] Get page title and description
  - [ ] Identify content type/category
- [ ] Implement rate limiting and retry (AC: 5)
  - [ ] Add rate limiter (e.g., 1 req/second)
  - [ ] Implement exponential backoff
  - [ ] Set max retry attempts (3)
  - [ ] Handle rate limit headers
  - [ ] Queue requests if needed
  - [ ] Log rate limit events
- [ ] Support batch URL processing (AC: 6)
  - [ ] Accept array of URLs
  - [ ] Process URLs in parallel (max 3)
  - [ ] Aggregate results
  - [ ] Handle partial failures
  - [ ] Progress reporting
  - [ ] Return batch results structure

## Dev Notes

### Architecture Reference (docs/architecture/components.md):
**Collector Agent Component:**
- Responsibility: Process diverse sources and extract meaningful signals
- Key Interface: `collect(sources: Source[]): ContentBrief`
- Dependencies: Methodology Engine, Web Fetch, Document Parser

### URL Processing Pipeline:
```typescript
interface URLProcessor {
  validate(url: string): boolean;
  fetch(url: string): Promise<HTMLContent>;
  convert(html: HTMLContent): MarkdownContent;
  extractMetadata(html: HTMLContent): Metadata;
  process(urls: string[]): Promise<ProcessedContent[]>;
}

interface ProcessedContent {
  url: string;
  markdown: string;
  metadata: {
    title?: string;
    author?: string;
    date?: string;
    description?: string;
    tags?: string[];
  };
  fetchedAt: Date;
}
```

### Libraries to Consider:
- **Fetch**: Use built-in fetch API or axios
- **HTML to Markdown**: turndown, html-to-md, or pandoc
- **HTML Parsing**: cheerio or jsdom for metadata extraction
- **Rate Limiting**: p-limit or bottleneck
- **URL Validation**: valid-url or native URL constructor

### Error Handling:
```typescript
enum FetchError {
  INVALID_URL = 'INVALID_URL',
  NETWORK_ERROR = 'NETWORK_ERROR',
  TIMEOUT = 'TIMEOUT',
  RATE_LIMITED = 'RATE_LIMITED',
  CONTENT_TOO_LARGE = 'CONTENT_TOO_LARGE',
  UNSUPPORTED_CONTENT = 'UNSUPPORTED_CONTENT'
}
```

### Rate Limiting Strategy:
- Default: 1 request per second
- Respect Retry-After headers
- Exponential backoff: 1s, 2s, 4s
- Max 3 retries per URL
- Queue overflow handling

### Testing
**Testing Framework:** Jest
**Test File Location:** `.flcm-core/tests/collector/`

**Unit Tests:**
- URL validation with various formats
- Mock fetch responses
- HTML to Markdown conversion samples
- Metadata extraction from sample HTML
- Rate limiter behavior

**Integration Tests:**
- Fetch real URLs (with mock server)
- Batch processing with mixed results
- Error recovery scenarios
- Rate limit compliance

**Manual Tests:**
- Process various website types
- Test with slow/failing URLs
- Verify markdown quality
- Check metadata accuracy

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_