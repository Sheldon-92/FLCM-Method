# Story 1.4: Document Flow Pipeline

## Status
ðŸ“ Not Started

## Story
**As a** system  
**I want** a structured document flow pipeline  
**So that** content moves through stages (insights â†’ content â†’ platforms) systematically

## Acceptance Criteria
1. Document schema defined for each stage (insights, content, platforms)
2. File watchers detect changes and trigger next stage
3. Metadata preserved and enriched across stages
4. Version tracking and rollback capability
5. Pipeline status monitoring and reporting

## Tasks / Subtasks
- [ ] Task 1: Define document schemas (AC: 1)
  - [ ] Subtask 1.1: Create insights.md schema with frontmatter
  - [ ] Subtask 1.2: Define content.md structure
  - [ ] Subtask 1.3: Design platform-specific formats
  - [ ] Subtask 1.4: Document metadata requirements

- [ ] Task 2: Implement file watchers (AC: 2)
  - [ ] Subtask 2.1: Set up chokidar for file monitoring
  - [ ] Subtask 2.2: Create event handlers for changes
  - [ ] Subtask 2.3: Implement debounce for rapid changes
  - [ ] Subtask 2.4: Add file validation before processing

- [ ] Task 3: Metadata management (AC: 3)
  - [ ] Subtask 3.1: Design metadata structure
  - [ ] Subtask 3.2: Implement frontmatter parser
  - [ ] Subtask 3.3: Create metadata enrichment logic
  - [ ] Subtask 3.4: Build metadata inheritance system

- [ ] Task 4: Version control (AC: 4)
  - [ ] Subtask 4.1: Implement document versioning
  - [ ] Subtask 4.2: Create diff tracking
  - [ ] Subtask 4.3: Build rollback mechanism
  - [ ] Subtask 4.4: Add version comparison tools

- [ ] Task 5: Pipeline monitoring (AC: 5)
  - [ ] Subtask 5.1: Create pipeline state manager
  - [ ] Subtask 5.2: Implement progress tracking
  - [ ] Subtask 5.3: Add performance metrics
  - [ ] Subtask 5.4: Build status reporting API

## Dev Notes

### Document Flow Stages
```
1. Input Stage
   â†“ (Scholar processes)
2. Insights Stage (insights.md)
   â†“ (Creator processes)
3. Content Stage (content.md)
   â†“ (Publisher processes)
4. Platform Stage (xiaohongshu.md, zhihu.md, etc.)
```

### Document Schemas

#### Insights Document (insights.md)
```markdown
---
id: unique-document-id
timestamp: 2025-09-01T10:00:00Z
source:
  type: pdf
  path: ./input/research.pdf
  hash: sha256-hash
frameworks:
  - SWOT-USED
  - SCAMPER
metadata:
  author: System
  version: 1.0
  stage: insights
---

# Insights: [Topic]

## Key Findings
...

## Framework Analysis
### SWOT-USED Results
...
```

#### Content Document (content.md)
```markdown
---
id: unique-document-id
timestamp: 2025-09-01T11:00:00Z
source:
  insights: ./insights/unique-document-id.md
voiceDNA:
  profile: user-voice-profile
  confidence: 0.95
mode: standard
metadata:
  author: Creator Agent
  version: 1.0
  stage: content
---

# [Title]

[Generated content with Voice DNA applied]
```

#### Platform Document (xiaohongshu.md)
```markdown
---
id: unique-document-id
timestamp: 2025-09-01T12:00:00Z
source:
  content: ./content/unique-document-id.md
platform: xiaohongshu
optimizations:
  - emoji_enhancement
  - hashtag_generation
  - length_optimization
metadata:
  author: Publisher Agent
  version: 1.0
  stage: published
---

[Platform-optimized content]

#æ ‡ç­¾1 #æ ‡ç­¾2 #æ ‡ç­¾3
```

### Pipeline State Machine
```typescript
enum PipelineStage {
  INPUT = 'input',
  PROCESSING_INSIGHTS = 'processing_insights',
  INSIGHTS_READY = 'insights_ready',
  PROCESSING_CONTENT = 'processing_content',
  CONTENT_READY = 'content_ready',
  PROCESSING_PUBLISH = 'processing_publish',
  PUBLISHED = 'published',
  ERROR = 'error'
}

interface PipelineState {
  documentId: string;
  currentStage: PipelineStage;
  startTime: Date;
  lastUpdate: Date;
  stages: StageHistory[];
  errors: Error[];
}
```

### File Watcher Configuration
```typescript
const watcherConfig = {
  paths: {
    input: './data/input',
    insights: './data/insights',
    content: './data/content',
    published: './data/published'
  },
  options: {
    ignored: /(^|[\/\\])\../,  // ignore dotfiles
    persistent: true,
    awaitWriteFinish: {
      stabilityThreshold: 2000,
      pollInterval: 100
    }
  },
  debounce: 500  // milliseconds
};
```

### Metadata Flow
```
Input â†’ Insights:
  - Add processing timestamp
  - Add framework results
  - Preserve source info

Insights â†’ Content:
  - Add Voice DNA profile
  - Add creation mode
  - Link to insights

Content â†’ Platform:
  - Add platform optimizations
  - Add publishing metadata
  - Preserve content link
```

## Testing Requirements

### Edge Case Testing Scenarios
```typescript
describe('Document Pipeline Edge Cases', () => {
  test('Handles corrupted metadata gracefully', async () => {
    const corruptedDoc = createDocumentWithInvalidMetadata();
    const result = await pipeline.process(corruptedDoc);
    
    expect(result.status).toBe('processed_with_warnings');
    expect(result.warnings).toContain('Invalid metadata reconstructed');
    expect(result.document.metadata.id).toBeDefined(); // Auto-generated
  });

  test('Processes very large documents (>100MB)', async () => {
    const largeDoc = createLargeDocument(100 * 1024 * 1024); // 100MB
    const result = await pipeline.process(largeDoc);
    
    expect(result.processingTime).toBeLessThan(30000); // 30s max
    expect(result.status).toBe('processed');
  });

  test('Handles concurrent document processing', async () => {
    const documents = createMultipleDocuments(10);
    const results = await Promise.all(
      documents.map(doc => pipeline.process(doc))
    );
    
    expect(results.every(r => r.status === 'processed')).toBe(true);
    expect(results.map(r => r.document.id)).toHaveNoDuplicates();
  });
});
```

### File System Edge Cases
1. **Disk Space Exhaustion**: Graceful failure with cleanup
2. **Permission Denied**: Clear error message with suggested fix
3. **Network Drive Disconnection**: Automatic retry with local fallback
4. **File Locking**: Wait-and-retry pattern with timeout
5. **Rapid File Changes**: Debounce mechanism to prevent duplicate processing

### Version Control Scenarios
1. **Merge Conflicts**: Automatic resolution for metadata conflicts
2. **Missing Version**: Reconstruct from available history
3. **Rollback to Non-existent Version**: Fallback to nearest available
4. **Version Storage Corruption**: Recovery from backup metadata

## Definition of Done
- [ ] Document schemas defined and validated
- [ ] File watchers operational
- [ ] Metadata flows correctly
- [ ] Version control working
- [ ] Pipeline monitoring active

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-01 | 1.0 | Initial story creation | System |

## Dev Agent Record
*To be populated during development*

### File List
**To Create:**
- `.flcm-core/shared/pipeline/document-schema.ts`
- `.flcm-core/shared/pipeline/file-watcher.ts`
- `.flcm-core/shared/pipeline/metadata-manager.ts`
- `.flcm-core/shared/pipeline/version-control.ts`
- `.flcm-core/shared/pipeline/pipeline-monitor.ts`
- `.flcm-core/templates/insights.md`
- `.flcm-core/templates/content.md`
- `.flcm-core/templates/platforms/*.md`