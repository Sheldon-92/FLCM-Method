# Story 1.5: Document Pipeline Architecture

## Status
Completed

## Story
**As a** system,  
**I want** a robust document processing pipeline,  
**so that** content flows smoothly between agents.

**Estimated Time:** 6-7 hours

## Acceptance Criteria
1. Document schema definitions created
2. Document validation framework implemented
3. Document transformation utilities built
4. Document versioning system established
5. Document metadata management added
6. Document storage abstraction layer created

## Tasks / Subtasks
- [x] Define document schemas (AC: 1)
  - [x] Create ContentBrief schema
    - [x] Define sources array structure
    - [x] Define insights structure
    - [x] Define signal score fields
    - [x] Define concept tags
  - [x] Create KnowledgeSynthesis schema
    - [x] Define concept structure
    - [x] Define depth levels (1-5)
    - [x] Define analogies format
    - [x] Define confidence scoring
  - [x] Create ContentDraft schema
    - [x] Define content body structure
    - [x] Define voice profile format
    - [x] Define revision tracking
    - [x] Define hook points
  - [x] Create PlatformAdaptation schema
    - [x] Define platform-specific fields
    - [x] Define optimization metadata
    - [x] Define hashtag structure
    - [x] Define media prompts
- [x] Implement validation framework (AC: 2)
  - [x] Create DocumentValidator class
  - [x] Implement schema validation rules
  - [x] Add frontmatter validation
  - [x] Validate markdown structure
  - [x] Check required fields
  - [x] Validate field types and formats
  - [x] Create validation error reports
- [x] Build transformation utilities (AC: 3)
  - [x] Create DocumentTransformer class
  - [x] Implement Brief → Synthesis transformer
  - [x] Implement Synthesis → Draft transformer
  - [x] Implement Draft → Adaptation transformer
  - [x] Add markdown processing utilities
  - [x] Create frontmatter parser/serializer
  - [x] Build link converter for Obsidian
- [x] Establish versioning system (AC: 4)
  - [x] Implement version tracking in metadata
  - [x] Create revision history structure
  - [x] Add diff generation for changes
  - [x] Support rollback to previous versions
  - [x] Track modification timestamps
  - [x] Identify change authors (agents)
- [x] Add metadata management (AC: 5)
  - [x] Create MetadataManager class
  - [x] Define YAML frontmatter structure
  - [x] Implement metadata extraction
  - [x] Add metadata merging logic
  - [x] Support custom metadata fields
  - [x] Create metadata indexing
- [x] Create storage abstraction layer (AC: 6)
  - [x] Define DocumentStorage interface
  - [x] Implement FileSystemStorage class
  - [x] Add path resolution logic
  - [x] Create document naming conventions
  - [x] Implement save/load operations
  - [x] Add search/query capabilities
  - [x] Support batch operations

## Dev Notes

### Document Pipeline from Architecture (docs/architecture/data-models.md):

Document Flow:
1. **ContentBrief** (Collector output)
2. **KnowledgeSynthesis** (Scholar output)
3. **ContentDraft** (Creator output)
4. **PlatformAdaptation[]** (Adapter output)

### Document Schemas (TypeScript):
```typescript
interface ContentBrief {
  id: string;
  created: Date;
  sources: Source[];
  insights: Insight[];
  signalScore: number;
  concepts: string[];
  contradictions: Contradiction[];
  metadata: {
    agent: 'collector';
    methodology: string[];
  };
}

interface KnowledgeSynthesis {
  id: string;
  concept: string;
  depthLevel: 1 | 2 | 3 | 4 | 5;
  explanation: string[];
  analogies: Analogy[];
  questions: Question[];
  confidence: number;
  teachingReady: boolean;
  metadata: {
    agent: 'scholar';
    methodology: string[];
  };
}

interface ContentDraft {
  id: string;
  title: string;
  content: string;
  voiceDNA: VoiceProfile;
  revisions: Revision[];
  structure: ContentStructure;
  hooks: Hook[];
  wordCount: number;
  metadata: {
    agent: 'creator';
    methodology: string[];
    iterations: number;
  };
}

interface PlatformAdaptation {
  id: string;
  platform: 'wechat' | 'xiaohongshu' | 'linkedin' | 'twitter';
  adaptedContent: string;
  optimizations: Optimization[];
  hashtags: string[];
  mediaPrompts: string[];
  characterCount: number;
  metadata: {
    agent: 'adapter';
    methodology: string[];
    platformRules: string[];
  };
}
```

### Frontmatter Format (from docs/architecture/database-schema.md):
```yaml
---
flcm_type: content-brief
flcm_id: brief-2024-12-28-001
agent: collector
status: processed
created: 2024-12-28T10:00:00
modified: 2024-12-28T10:30:00
version: 1
sources: [...]
signal_score: 0.87
concepts: [concept1, concept2]
methodologies_used: [RICE, SignalToNoise]
---
```

### Storage Structure:
```
docs/
├── content/
│   └── briefs/
│       └── brief-2024-12-28-001.md
├── knowledge/
│   └── syntheses/
│       └── knowledge-2024-12-28-001.md
├── creation/
│   └── drafts/
│       └── draft-2024-12-28-001.md
└── publish/
    └── adaptations/
        └── [platform]-2024-12-28-001.md
```

### Validation Rules:
- All documents must have valid frontmatter
- Required fields must be present
- Dates must be ISO 8601 format
- IDs must follow naming convention
- Status must be from allowed values
- Agent must be valid agent ID
- Methodologies must exist in library

### Storage Interface:
```typescript
interface DocumentStorage {
  save(doc: Document): Promise<void>;
  load(id: string): Promise<Document>;
  query(filter: QueryFilter): Promise<Document[]>;
  delete(id: string): Promise<void>;
  exists(id: string): Promise<boolean>;
  list(type?: DocumentType): Promise<string[]>;
}
```

### Testing
- Unit tests for each schema
- Validation tests with invalid documents
- Transformation pipeline tests
- Version management tests
- Storage operations tests
- Integration test: Full document pipeline
- Performance test: Large document handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1

### Debug Log References
- Document schemas implementation: 2024-12-28
- Validation framework created
- Transformation utilities built
- Metadata management implemented
- Storage abstraction layer completed
- Pipeline coordinator added

### Completion Notes List
- Created comprehensive document schemas for all pipeline stages (ContentBrief, KnowledgeSynthesis, ContentDraft, PlatformAdaptation)
- Built robust validation framework with type-specific rules and frontmatter support
- Implemented document transformer for stage-to-stage conversions
- Created metadata manager with frontmatter handling and indexing
- Built file system storage with versioning and backup support
- Added main pipeline coordinator for orchestrating document flow
- Included Obsidian-compatible features (wiki-links, frontmatter)
- All components isolated in .flcm-core/pipeline/ for independence
- Full error handling and recovery mechanisms included

### File List
- Created: .flcm-core/pipeline/document-schemas.ts (Core document types)
- Created: .flcm-core/pipeline/document-validator.ts (Validation framework)
- Created: .flcm-core/pipeline/document-transformer.ts (Transformation utilities)
- Created: .flcm-core/pipeline/metadata-manager.ts (Metadata and frontmatter)
- Created: .flcm-core/pipeline/document-storage.ts (Storage abstraction)
- Created: .flcm-core/pipeline/document-pipeline.ts (Pipeline coordinator)

## QA Results
_To be filled by QA agent_